# 分离词表构建与预训练词向量加载功能计划

## 1. 需求分析

需要将train.py中以下功能分离到prepare_data.py文件中：
- 从原始数据构建词表
- 加载预训练词向量
- 将词表和词向量矩阵保存为文件

同时，修改train.py，仅保留从文件中读取词表和词向量的功能。

## 2. 分离的代码范围

从train.py中分离以下部分：
1. 数据加载部分（70-77行）
2. 预训练词向量加载部分（79-93行）
3. 词汇表构建部分（95-118行）
4. 词向量矩阵生成部分（130-146行和182-198行）

## 3. prepare_data.py设计

### 3.1 模块结构
```python
# 导入必要的模块
import torch
import argparse
import os
import pickle
from data import Preprocessor, Vocabulary
from utils.embedding import PretrainedEmbedding

# 命令行参数配置
parser = argparse.ArgumentParser(description='数据准备：构建词表和加载预训练词向量')
# 添加必要的参数

# 主函数
def main():
    # 解析参数
    # 加载数据
    # 构建词表
    # 加载预训练词向量
    # 生成词向量矩阵
    # 保存词表和词向量矩阵

if __name__ == '__main__':
    main()
```

### 3.2 功能实现
1. **数据加载**：从指定目录加载训练数据
2. **词表构建**：使用Preprocessor和Vocabulary类构建源语言和目标语言词表
3. **预训练词向量加载**：使用PretrainedEmbedding类加载预训练词向量
4. **词向量矩阵生成**：生成与词表对应的词向量矩阵
5. **数据保存**：使用pickle将词表和词向量矩阵保存为文件

### 3.3 保存文件格式
- 源语言词表：`src_vocab.pkl`
- 目标语言词表：`tgt_vocab.pkl`
- 源语言词向量矩阵：`src_embedding.pkl`
- 目标语言词向量矩阵：`tgt_embedding.pkl`

## 4. train.py修改

### 4.1 移除部分
- 数据加载代码
- 预训练词向量加载代码
- 词汇表构建代码
- 词向量矩阵生成代码

### 4.2 添加部分
```python
# 加载词表和词向量矩阵
with open(os.path.join(args.save_dir, 'src_vocab.pkl'), 'rb') as f:
    src_vocab = pickle.load(f)

with open(os.path.join(args.save_dir, 'tgt_vocab.pkl'), 'rb') as f:
    tgt_vocab = pickle.load(f)

with open(os.path.join(args.save_dir, 'src_embedding.pkl'), 'rb') as f:
    src_embedding_matrix = pickle.load(f)

with open(os.path.join(args.save_dir, 'tgt_embedding.pkl'), 'rb') as f:
    tgt_embedding_matrix = pickle.load(f)
```

## 5. 实现步骤

1. 创建prepare_data.py文件
2. 实现数据加载、词表构建、预训练词向量加载和数据保存功能
3. 修改train.py，移除原有的词表构建和词向量加载代码
4. 添加从文件中读取词表和词向量的代码
5. 测试prepare_data.py和train.py的功能

## 6. 注意事项

1. 确保prepare_data.py生成的文件路径与train.py中读取路径一致
2. 确保数据格式兼容，使用pickle序列化时注意版本兼容性
3. 保持与原有代码的功能一致性
4. 添加必要的日志输出，便于调试和监控

## 7. 测试计划

1. 运行prepare_data.py，生成词表和词向量文件
2. 运行train.py，测试是否能正确加载生成的文件
3. 验证模型训练是否正常进行

通过以上步骤，将成功实现词表构建与预训练词向量加载功能的分离，提高代码的模块化程度和可维护性。